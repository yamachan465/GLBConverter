<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ARè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ  - ãƒãƒ¼ã‚«ãƒ¼ & GLB ä¸€æ‹¬ç”Ÿæˆ</title>
  <link rel="icon" href="data:,">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    .header p {
      margin: 10px 0 0;
      opacity: 0.9;
      font-size: 14px;
    }
    .content {
      padding: 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title .badge {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .table-container {
      overflow-x: auto;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      max-height: 600px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    th {
      background: #f3f4f6;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
    }
    tbody tr:hover {
      background: #f9fafb;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 12px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    .file-input-wrapper {
      position: relative;
    }
    .file-input-btn {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      display: inline-block;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .file-input-btn:hover {
      background: #5568d3;
    }
    .file-input-btn input[type="file"] {
      display: none;
    }
    .file-name {
      display: block;
      margin-top: 4px;
      font-size: 10px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 120px;
    }
    .actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
      justify-content: center;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .progress-section {
      display: none;
      margin-top: 30px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .progress-section.active {
      display: block;
    }
    .progress-bar-wrapper {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      font-size: 14px;
      color: #374151;
      text-align: center;
      font-weight: 600;
    }
    .log {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: #374151;
      line-height: 1.6;
    }
    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #1e40af;
    }
    .info-box ul {
      margin: 10px 0 0;
      padding-left: 20px;
    }
    .info-box li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ARè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ </h1>
      <p>30äººåˆ†ã®ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‹ã‚‰.mindãƒ•ã‚¡ã‚¤ãƒ«ã¨GLBãƒ¢ãƒ‡ãƒ«ã‚’ä¸€æ‹¬ç”Ÿæˆ</p>
    </div>

    <div class="content">
      <div class="info-box">
        <strong>ğŸ“‹ ä½¿ã„æ–¹</strong>
        <ul>
          <li>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ç”»åƒURLã‹ã‚‰è‡ªå‹•å–å¾—</li>
          <li>ç”»åƒ1ã€œ3: GLBã«å¤‰æ›ã•ã‚Œã‚‹ç”»åƒ</li>
          <li>ãƒãƒ¼ã‚«ãƒ¼ç”»åƒ1ã€œ3: .mindãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã«ä½¿ç”¨ã•ã‚Œã‚‹ç”»åƒ</li>
          <li>å‡¦ç†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€30äººåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’å«ã‚€1ã¤ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™</li>
          <li>âš ï¸ ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼ˆåˆå›ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰</li>
        </ul>
      </div>

      <div class="section">
        <div class="section-title">
          <span>ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
          <span class="badge">æ¨å¥¨</span>
        </div>
        <div style="margin-bottom: 20px;">
          <label class="file-input-btn" style="padding: 10px 20px; font-size: 14px; cursor: pointer;">
            ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            <input type="file" id="csvInput" accept=".csv" style="display: none;" />
          </label>
          <span id="csvFileName" style="margin-left: 12px; color: #6b7280; font-size: 13px;"></span>
          <div style="margin-top: 12px; font-size: 12px; color: #6b7280;">
            <strong>CSVå½¢å¼:</strong><br>
            â€¢ Aåˆ—: æ´»å‹•å<br>
            â€¢ B-Dåˆ—: ç”»åƒ1ã€œ3ã®URLï¼ˆGLBåŒ–ï¼‰<br>
            â€¢ E-Gåˆ—: ãƒãƒ¼ã‚«ãƒ¼1ã€œ3ã®URLï¼ˆ.mindç”Ÿæˆï¼‰<br>
            <br>Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰ãƒªãƒ³ã‚¯ã¾ãŸã¯ç”»åƒURLã‚’å„ã‚»ãƒ«ã«è¨˜å…¥ã—ã¦ãã ã•ã„
          </div>
        </div>
      </div>

      <div class="section" id="statusSection" style="display: none;">
        <div class="section-title">
          <span>ğŸ“Š ã‚¤ãƒ³ãƒãƒ¼ãƒˆçŠ¶æ³</span>
        </div>
        <div id="statusContent" style="padding: 15px; background: #f9fafb; border-radius: 8px; font-size: 13px; max-height: 400px; overflow-y: auto;">
          CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="processBtn">
          <span>ğŸš€</span>
          <span>ä¸€æ‹¬å‡¦ç†ã‚’é–‹å§‹</span>
        </button>
        <button class="btn btn-secondary" id="clearBtn">
          <span>ğŸ—‘ï¸</span>
          <span>ã‚¯ãƒªã‚¢</span>
        </button>
      </div>

      <div class="progress-section" id="progressSection">
        <div class="progress-text" id="progressText">å‡¦ç†ä¸­...</div>
        <div class="progress-bar-wrapper">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
  <script type="module">
    let csvData = [];  // CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿
    let downloadedFiles = {};  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«

    // Load required libraries
    const loadModule = async (urls) => {
      for (const url of urls) {
        try { return await import(url); } catch (e) { console.warn("load fail", url, e?.message); }
      }
      throw new Error("å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
    };

    const {Document, WebIO} = await loadModule([
      "https://esm.sh/@gltf-transform/core@4.2.1?bundle",
      "https://esm.sh/@gltf-transform/core?bundle"
    ]);
    const {KHRMaterialsUnlit} = await loadModule([
      "https://esm.sh/@gltf-transform/extensions@4.2.1?bundle",
      "https://esm.sh/@gltf-transform/extensions?bundle"
    ]);
    const {zipSync} = await loadModule([
      "https://esm.sh/fflate@0.8.1?bundle",
      "https://esm.sh/fflate?bundle"
    ]);

    console.log('âœ… Libraries loaded successfully');

    // Google Drive URL conversion
    function convertGoogleDriveUrl(url) {
      if (!url || typeof url !== 'string') return url;

      // Pattern 1: https://drive.google.com/file/d/FILE_ID/view
      const match1 = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        return `https://drive.google.com/uc?export=download&id=${match1[1]}`;
      }

      // Pattern 2: https://drive.google.com/open?id=FILE_ID
      const match2 = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
      if (match2) {
        return `https://drive.google.com/uc?export=download&id=${match2[1]}`;
      }

      // Pattern 3: Already direct link or other URL
      return url;
    }

    // Fetch image from URL and convert to File object
    async function fetchImageAsFile(url, filename) {
      try {
        // Try direct fetch first
        let response;
        let blob;

        try {
          const directUrl = convertGoogleDriveUrl(url);
          response = await fetch(directUrl, { mode: 'cors' });

          if (response.ok) {
            blob = await response.blob();
          } else {
            throw new Error('Direct fetch failed, trying proxy');
          }
        } catch (directError) {
          // If direct fetch fails (CORS), use server proxy
          console.log('Using proxy for:', url);
          const proxyUrl = `http://localhost:3000/api/proxy-image?url=${encodeURIComponent(url)}`;
          response = await fetch(proxyUrl);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          blob = await response.blob();
        }

        // Detect file extension from blob type or URL
        let extension = 'png';
        if (blob.type.includes('jpeg') || blob.type.includes('jpg')) {
          extension = 'jpg';
        } else if (blob.type.includes('png')) {
          extension = 'png';
        } else if (blob.type.includes('webp')) {
          extension = 'webp';
        }

        const file = new File([blob], `${filename}.${extension}`, { type: blob.type });
        return file;
      } catch (error) {
        console.error(`Failed to fetch ${url}:`, error);
        throw error;
      }
    }

    // Parse CSV (ã‚«ãƒ©ãƒ ä½ç½®ãƒ™ãƒ¼ã‚¹: A=åå‰, B-D=ç”»åƒ, E-G=ãƒãƒ¼ã‚«ãƒ¼)
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const data = [];

      // Skip header row (row 0), start from row 1
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const values = lines[i].split(',').map(v => v.trim());

        // Aåˆ—=æ´»å‹•å, B-Dåˆ—=ç”»åƒ, E-Gåˆ—=ãƒãƒ¼ã‚«ãƒ¼
        const row = {
          activityName: values[0] || `æ´»å‹•${i}`,  // Aåˆ—
          image1: values[1] || '',                // Båˆ—
          image2: values[2] || '',                // Cåˆ—
          image3: values[3] || '',                // Dåˆ—
          marker1: values[4] || '',               // Eåˆ—
          marker2: values[5] || '',               // Fåˆ—
          marker3: values[6] || ''                // Gåˆ—
        };

        data.push(row);
      }

      return data;
    }

    // CSV Import Handler
    document.getElementById('csvInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('csvFileName').textContent = file.name;
      document.getElementById('statusSection').style.display = 'block';

      const progressSection = document.getElementById('progressSection');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const log = document.getElementById('log');
      const statusContent = document.getElementById('statusContent');

      const addLog = (msg) => {
        log.textContent += msg + '\n';
        log.scrollTop = log.scrollHeight;
      };

      const updateStatus = (msg) => {
        statusContent.innerHTML += msg + '<br>';
        statusContent.scrollTop = statusContent.scrollHeight;
      };

      try {
        progressSection.classList.add('active');
        log.textContent = '';
        statusContent.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = 'CSVã‚’èª­ã¿è¾¼ã¿ä¸­...';

        // Read CSV
        const text = await file.text();
        csvData = parseCSV(text);

        addLog(`ğŸ“„ CSVèª­ã¿è¾¼ã¿å®Œäº†: ${csvData.length}è¡Œ`);
        updateStatus(`ğŸ“„ <strong>CSVèª­ã¿è¾¼ã¿å®Œäº†: ${csvData.length}äººåˆ†</strong>`);

        if (csvData.length === 0) {
          alert('CSVã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          progressSection.classList.remove('active');
          return;
        }

        progressText.textContent = 'ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
        const totalImages = csvData.length * 6;
        let downloadedImages = 0;
        downloadedFiles = {};

        // Process each row
        for (let i = 0; i < csvData.length; i++) {
          const row = csvData[i];
          const rowIndex = i;

          updateStatus(`<br><strong>[${i + 1}/${csvData.length}] ${row.activityName}</strong>`);
          addLog(`\n[${i + 1}/${csvData.length}] ${row.activityName}`);

          // Download images
          const imageTypes = ['image1', 'image2', 'image3', 'marker1', 'marker2', 'marker3'];

          for (const type of imageTypes) {
            const url = row[type];

            if (!url) {
              updateStatus(`âš ï¸ ${type}: URLãŒç©ºã§ã™`);
              addLog(`  âš ï¸ ${type}: URLãŒç©ºã§ã™`);
              downloadedImages++;
              progressBar.style.width = `${(downloadedImages / totalImages) * 100}%`;
              continue;
            }

            try {
              addLog(`  â¬‡ï¸ ${type}: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...`);
              const imageFile = await fetchImageAsFile(url, `${row.activityName}_${type}`);

              // Store in downloadedFiles with rowIndex and type
              const key = `${rowIndex}_${type}`;
              downloadedFiles[key] = imageFile;

              updateStatus(`âœ… ${type}: ${imageFile.name}`);
              addLog(`  âœ… ${type}: ${imageFile.name}`);
            } catch (error) {
              updateStatus(`âŒ ${type}: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—`);
              addLog(`  âŒ ${type}: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•— - ${error.message}`);
            }

            downloadedImages++;
            progressBar.style.width = `${(downloadedImages / totalImages) * 100}%`;
          }
        }

        progressBar.style.width = '100%';
        progressText.textContent = 'âœ… CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼';
        updateStatus('<br>ğŸ‰ <strong>ã™ã¹ã¦ã®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼</strong>');
        addLog('\nğŸ‰ ã™ã¹ã¦ã®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        addLog('ã€ŒğŸš€ ä¸€æ‹¬å‡¦ç†ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã§å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');

      } catch (error) {
        console.error('CSV import error:', error);
        progressText.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        addLog(`\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        alert('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    });

    // GLB conversion function (from existing index.html)
    async function imageToGlb(file, {longSide = 1.0, doubleSided = true}) {
      const imgData = new Uint8Array(await file.arrayBuffer());
      const {width, height} = await getImageSize(imgData);
      const aspect = width / height || 1;
      const w = width >= height ? longSide : longSide * aspect;
      const h = width >= height ? longSide / aspect : longSide;

      const doc = new Document();
      const buffer = doc.createBuffer();
      const io = new WebIO().registerExtensions([KHRMaterialsUnlit]);
      const tex = doc.createTexture(file.name).setImage(imgData).setMimeType(file.type || "image/png");
      const unlit = doc.createExtension(KHRMaterialsUnlit).createUnlit();
      const mat = doc.createMaterial("unlit")
        .setBaseColorTexture(tex)
        .setAlphaMode("BLEND")
        .setDoubleSided(doubleSided)
        .setExtension("KHR_materials_unlit", unlit);

      const positions = new Float32Array([
        -w / 2, -h / 2, 0,
         w / 2, -h / 2, 0,
         w / 2,  h / 2, 0,
        -w / 2,  h / 2, 0
      ]);
      const uvs = new Float32Array([0, 1, 1, 1, 1, 0, 0, 0]);
      const indices = new Uint16Array([0, 1, 2, 0, 2, 3]);

      const prim = doc.createPrimitive()
        .setAttribute("POSITION", doc.createAccessor().setType("VEC3").setArray(positions).setBuffer(buffer))
        .setAttribute("TEXCOORD_0", doc.createAccessor().setType("VEC2").setArray(uvs).setBuffer(buffer))
        .setIndices(doc.createAccessor().setArray(indices).setBuffer(buffer))
        .setMaterial(mat);

      const mesh = doc.createMesh().addPrimitive(prim);
      const node = doc.createNode("plane").setMesh(mesh);
      doc.createScene().addChild(node);

      return io.writeBinary(doc);
    }

    function getImageSize(uint8) {
      return new Promise((resolve, reject) => {
        const blob = new Blob([uint8]);
        const img = new Image();
        img.onload = () => resolve({width: img.naturalWidth, height: img.naturalHeight});
        img.onerror = reject;
        img.src = URL.createObjectURL(blob);
      });
    }

    // MindAR .mind generation
    async function generateMindFile(markerFiles) {
      const images = [];
      for (const file of markerFiles) {
        const img = await loadImageElement(file);
        images.push(img);
      }

      const compiler = new window.MINDAR.IMAGE.Compiler();
      const dataList = await compiler.compileImageTargets(images, (progress) => {
        console.log('Compiler progress:', progress);
      });

      return dataList;
    }

    function loadImageElement(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function sanitizeFilename(name) {
      return name.replace(/[^a-z0-9_\-]/gi, '_');
    }

    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    // Process button
    document.getElementById('processBtn').addEventListener('click', async () => {
      if (csvData.length === 0) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„');
        return;
      }

      const processBtn = document.getElementById('processBtn');
      const progressSection = document.getElementById('progressSection');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const log = document.getElementById('log');

      const addLog = (msg) => {
        log.textContent += msg + '\n';
        log.scrollTop = log.scrollHeight;
      };

      // Start processing
      processBtn.disabled = true;
      progressSection.classList.add('active');
      log.textContent = '';
      progressBar.style.width = '0%';
      progressText.textContent = `${csvData.length}äººåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...`;

      try {
        addLog(`ğŸ“¦ ${csvData.length}äººåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†é–‹å§‹`);

        const zipEntries = {};
        const totalSteps = csvData.length * 4; // GLBÃ—3 + mindÃ—1
        let completedSteps = 0;

        for (let i = 0; i < csvData.length; i++) {
          const row = csvData[i];
          const folderName = sanitizeFilename(row.activityName);

          addLog(`\n[${i + 1}/${csvData.length}] ${row.activityName} ã‚’å‡¦ç†ä¸­...`);

          // Get files from downloadedFiles
          const image1 = downloadedFiles[`${i}_image1`];
          const image2 = downloadedFiles[`${i}_image2`];
          const image3 = downloadedFiles[`${i}_image3`];
          const marker1 = downloadedFiles[`${i}_marker1`];
          const marker2 = downloadedFiles[`${i}_marker2`];
          const marker3 = downloadedFiles[`${i}_marker3`];

          if (!image1 || !image2 || !image3 || !marker1 || !marker2 || !marker3) {
            addLog(`  âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
            completedSteps += 4;
            progressBar.style.width = `${(completedSteps / totalSteps) * 100}%`;
            continue;
          }

          // Convert images to GLB
          for (let j = 1; j <= 3; j++) {
            const imageFile = downloadedFiles[`${i}_image${j}`];
            addLog(`  â†’ ç”»åƒ${j} ã‚’GLBå¤‰æ›ä¸­...`);
            const glbBuffer = await imageToGlb(imageFile, { longSide: 1.0, doubleSided: true });
            zipEntries[`${folderName}/image${j}.glb`] = new Uint8Array(glbBuffer);
            completedSteps++;
            progressBar.style.width = `${(completedSteps / totalSteps) * 100}%`;
          }

          // Generate .mind file
          addLog(`  â†’ .mindãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...`);
          const markerFiles = [marker1, marker2, marker3];
          const mindData = await generateMindFile(markerFiles);
          zipEntries[`${folderName}/${folderName}.mind`] = new Uint8Array(mindData);

          // Create targets JSON
          const targets = [
            { id: 0, name: 'marker1', marker: `./${folderName}.mind`, model: './image1.glb' },
            { id: 1, name: 'marker2', marker: `./${folderName}.mind`, model: './image2.glb' },
            { id: 2, name: 'marker3', marker: `./${folderName}.mind`, model: './image3.glb' }
          ];
          const targetsJson = JSON.stringify(targets, null, 2);
          zipEntries[`${folderName}/targets-${folderName}.json`] = new TextEncoder().encode(targetsJson);

          completedSteps++;
          progressBar.style.width = `${(completedSteps / totalSteps) * 100}%`;
          addLog(`  âœ… ${row.activityName} å®Œäº†`);
        }

        // Create ZIP
        addLog('\nğŸ“¦ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­...');
        const zipData = zipSync(zipEntries, { level: 6 });

        // Download ZIP
        const blob = new Blob([zipData], { type: 'application/zip' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ar_output.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        progressBar.style.width = '100%';
        progressText.textContent = 'âœ… å‡¦ç†å®Œäº†ï¼';
        addLog('\nğŸ‰ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');

      } catch (error) {
        console.error('Error:', error);
        progressText.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        addLog(`\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        processBtn.disabled = false;
      }
    });

    // Clear button
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        csvData = [];
        downloadedFiles = {};
        document.getElementById('csvFileName').textContent = '';
        document.getElementById('statusSection').style.display = 'none';
        document.getElementById('progressSection').classList.remove('active');
        document.getElementById('csvInput').value = '';
      }
    });
  </script>
</body>
</html>
